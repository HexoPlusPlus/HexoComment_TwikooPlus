const env_id="YourEnvId",url="https://tcb-api.tencentcloudapi.com/web?env="+env_id,date=new Date,time=date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate();async function get_refresh_token(){const e={action:"auth.signInAnonymously",anonymous_uuid:"",dataVersion:time,env:env_id,refresh_token:"",seqId:""},t={body:JSON.stringify(e),method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}};return JSON.parse(await(await fetch(url,t)).text()).refresh_token}async function get_access_token(e){const t={action:"auth.fetchAccessTokenWithRefreshToken",anonymous_uuid:"",dataVersion:time,env:env_id,refresh_token:e,seqId:""},n={body:JSON.stringify(t),method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}};return JSON.parse(await(await fetch(url,n)).text()).access_token}async function get_comment(e,t,n){const a={event:"COMMENT_GET",url:t,before:n},o={access_token:e,action:"functions.invokeFunction",dataVersion:time,env:env_id,function_name:"twikoo",request_data:JSON.stringify(a),seqId:""},s={body:JSON.stringify(o),method:"POST",headers:{"content-type":"application/json;charset=UTF-8"}};return await(await fetch(url,s)).text()}async function handleRequest(e){const t=await JSON.parse(await e.text()),n=t.path,a=t.before;let o=await KVNAME.get("hpp_comment_refresh_token"),s=await KVNAME.get("hpp_comment_access_token"),i=await get_comment(s,n,a);return"CHECK_LOGIN_FAILED"==await JSON.parse(i).code&&(o=await get_refresh_token(),await KVNAME.put("hpp_comment_refresh_token",o),s=await get_access_token(o),await KVNAME.put("hpp_comment_access_token",s),i=await get_comment(s,n,a)),new Response(i,{headers:{"Access-Control-Allow-Origin":"*"}})}addEventListener("fetch",(e=>e.respondWith(handleRequest(e.request))));